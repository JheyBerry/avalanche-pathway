"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Serialization = exports.Serializable = exports.SERIALIZATIONVERSION = void 0;
/**
 * @packageDocumentation
 * @module Utils-Serialization
 */
const bintools_1 = __importDefault(require("../utils/bintools"));
const bn_js_1 = __importDefault(require("bn.js"));
const buffer_1 = require("buffer/");
const helperfunctions_1 = require("./helperfunctions");
exports.SERIALIZATIONVERSION = 0;
class Serializable {
    constructor() {
        this._typeName = undefined;
        this._typeID = undefined;
        this._codecID = undefined;
    }
    /**
     * Used in serialization. TypeName is a string name for the type of object being output.
     */
    getTypeName() {
        return this._typeName;
    }
    /**
     * Used in serialization. Optional. TypeID is a number for the typeID of object being output.
     */
    getTypeID() {
        return this._typeID;
    }
    /**
     * Used in serialization. Optional. TypeID is a number for the typeID of object being output.
     */
    getCodecID() {
        return this._codecID;
    }
    //sometimes the parent class manages the fields
    //these are so you can say super.serialize(encoding); 
    serialize(encoding) {
        return {
            "_typeName": this._typeName,
            "_typeID": (typeof this._typeID === "undefined" ? null : this._typeID),
            "_codecID": (typeof this._codecID === "undefined" ? null : this._codecID)
        };
    }
    ;
    deserialize(fields, encoding) {
        if (typeof fields["_typeName"] !== "string") {
            throw new Error("Error - Serializable.deserialize: _typeName must be a string, found: " + typeof fields["_typeName"]);
        }
        if (fields["_typeName"] !== this._typeName) {
            throw new Error("Error - Serializable.deserialize: _typeName mismatch -- expected: " + this._typeName + " -- recieved: " + fields["_typeName"]);
        }
        if (typeof fields["_typeID"] !== "undefined" && fields["_typeID"] !== null) {
            if (typeof fields["_typeID"] !== "number") {
                throw new Error("Error - Serializable.deserialize: _typeID must be a number, found: " + typeof fields["_typeID"]);
            }
            if (fields["_typeID"] !== this._typeID) {
                throw new Error("Error - Serializable.deserialize: _typeID mismatch -- expected: " + this._typeID + " -- recieved: " + fields["_typeID"]);
            }
        }
        if (typeof fields["_codecID"] !== "undefined" && fields["_codecID"] !== null) {
            if (typeof fields["_codecID"] !== "number") {
                throw new Error("Error - Serializable.deserialize: _codecID must be a number, found: " + typeof fields["_codecID"]);
            }
            if (fields["_codecID"] !== this._codecID) {
                throw new Error("Error - Serializable.deserialize: _codecID mismatch -- expected: " + this._codecID + " -- recieved: " + fields["_codecID"]);
            }
        }
    }
    ;
}
exports.Serializable = Serializable;
class Serialization {
    constructor() {
        this.bintools = bintools_1.default.getInstance();
    }
    /**
     * Retrieves the Serialization singleton.
     */
    static getInstance() {
        if (!Serialization.instance) {
            Serialization.instance = new Serialization();
        }
        return Serialization.instance;
    }
    bufferToType(vb, type, ...args) {
        if (type === "BN") {
            return new bn_js_1.default(vb.toString("hex"), "hex");
        }
        else if (type === "Buffer") {
            if (args.length == 1 && typeof args[0] === "number") {
                vb = buffer_1.Buffer.from(vb.toString("hex").padStart(args[0] * 2, '0'), "hex");
            }
            return vb;
        }
        else if (type === "bech32") {
            return this.bintools.addressToString(args[0], args[1], vb);
        }
        else if (type === "nodeID") {
            return helperfunctions_1.bufferToNodeIDString(vb);
        }
        else if (type === "privateKey") {
            return helperfunctions_1.bufferToPrivateKeyString(vb);
        }
        else if (type === "cb58") {
            return this.bintools.cb58Encode(vb);
        }
        else if (type === "base58") {
            return this.bintools.bufferToB58(vb);
        }
        else if (type === "base64") {
            return vb.toString("base64");
        }
        else if (type === "hex") {
            return vb.toString("hex");
        }
        else if (type === "decimalString") {
            return new bn_js_1.default(vb.toString("hex"), "hex").toString(10);
        }
        else if (type === "number") {
            return new bn_js_1.default(vb.toString("hex"), "hex").toNumber();
        }
        else if (type === "utf8") {
            return vb.toString("utf8");
        }
        return undefined;
    }
    typeToBuffer(v, type, ...args) {
        if (type === "BN") {
            let str = v.toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "Buffer") {
            return v;
        }
        else if (type === "bech32") {
            return this.bintools.stringToAddress(v);
        }
        else if (type === "nodeID") {
            return helperfunctions_1.NodeIDStringToBuffer(v);
        }
        else if (type === "privateKey") {
            return helperfunctions_1.privateKeyStringToBuffer(v);
        }
        else if (type === "cb58") {
            return this.bintools.cb58Decode(v);
        }
        else if (type === "base58") {
            return this.bintools.b58ToBuffer(v);
        }
        else if (type === "base64") {
            return buffer_1.Buffer.from(v, "base64");
        }
        else if (type === "hex") {
            if (v.startsWith("0x")) {
                v = v.slice(2);
            }
            return buffer_1.Buffer.from(v, "hex");
        }
        else if (type === "decimalString") {
            let str = new bn_js_1.default(v, 10).toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "number") {
            let str = new bn_js_1.default(v, 10).toString("hex");
            if (args.length == 1 && typeof args[0] === "number") {
                return buffer_1.Buffer.from(str.padStart(args[0] * 2, '0'), 'hex');
            }
            return buffer_1.Buffer.from(str, 'hex');
        }
        else if (type === "utf8") {
            if (args.length == 1 && typeof args[0] === "number") {
                let b = buffer_1.Buffer.alloc(args[0]);
                b.write(v);
                return b;
            }
            return buffer_1.Buffer.from(v, 'utf8');
        }
        return undefined;
    }
    encoder(value, encoding, intype, outtype, ...args) {
        if (typeof value === "undefined") {
            throw new Error("Error - Serializable.encoder: value passed is undefined");
        }
        if (encoding !== "display") {
            outtype = encoding;
        }
        let vb = this.typeToBuffer(value, intype, ...args);
        return this.bufferToType(vb, outtype, ...args);
    }
    decoder(value, encoding, intype, outtype, ...args) {
        if (typeof value === "undefined") {
            throw new Error("Error - Serializable.decoder: value passed is undefined");
        }
        if (encoding !== "display") {
            intype = encoding;
        }
        let vb = this.typeToBuffer(value, intype, ...args);
        return this.bufferToType(vb, outtype, ...args);
    }
    serialize(serialize, vm, encoding = "display", notes = undefined) {
        if (typeof notes === "undefined") {
            notes = serialize.getTypeName();
        }
        return {
            vm,
            encoding,
            version: exports.SERIALIZATIONVERSION,
            notes,
            fields: serialize.serialize(encoding)
        };
    }
    deserialize(input, output) {
        output.deserialize(input["fields"], input["encoding"]);
    }
}
exports.Serialization = Serialization;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VyaWFsaXphdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9zZXJpYWxpemF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBOzs7R0FHRztBQUNILGlFQUF5QztBQUN6QyxrREFBdUI7QUFDdkIsb0NBQWlDO0FBQ2pDLHVEQUFtSTtBQUV0SCxRQUFBLG9CQUFvQixHQUFHLENBQUMsQ0FBQztBQTRCdEMsTUFBc0IsWUFBWTtJQUFsQztRQUNjLGNBQVMsR0FBVSxTQUFTLENBQUM7UUFDN0IsWUFBTyxHQUFVLFNBQVMsQ0FBQztRQUMzQixhQUFRLEdBQVcsU0FBUyxDQUFDO0lBd0QzQyxDQUFDO0lBdERHOztPQUVHO0lBQ0gsV0FBVztRQUNQLE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMxQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTO1FBQ0wsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFBO0lBQ3ZCLENBQUM7SUFFRDs7T0FFRztJQUNILFVBQVU7UUFDUixPQUFPLElBQUksQ0FBQyxRQUFRLENBQUE7SUFDdEIsQ0FBQztJQUVELCtDQUErQztJQUMvQyxzREFBc0Q7SUFDdEQsU0FBUyxDQUFDLFFBQTRCO1FBQ2xDLE9BQU87WUFDSCxXQUFXLEVBQUUsSUFBSSxDQUFDLFNBQVM7WUFDM0IsU0FBUyxFQUFFLENBQUMsT0FBTyxJQUFJLENBQUMsT0FBTyxLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO1lBQ3RFLFVBQVUsRUFBRSxDQUFDLE9BQU8sSUFBSSxDQUFDLFFBQVEsS0FBSyxXQUFXLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQztTQUM1RSxDQUFBO0lBQ0wsQ0FBQztJQUFBLENBQUM7SUFDRixXQUFXLENBQUMsTUFBYSxFQUFFLFFBQTRCO1FBQ25ELElB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LEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBR0QsT0FBTyxDQUFDLEtBQVksRUFBRSxRQUEyQixFQUFFLE1BQXFCLEVBQUUsT0FBc0IsRUFBRSxHQUFHLElBQWU7UUFDaEgsSUFBRyxPQUFPLEtBQUssS0FBSyxXQUFXLEVBQUM7WUFDNUIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO1NBQzlFO1FBQ0QsSUFBRyxRQUFRLEtBQUssU0FBUyxFQUFFO1lBQ3ZCLE1BQU0sR0FBRyxRQUFRLENBQUM7U0FDckI7UUFDRCxJQUFJLEVBQUUsR0FBVSxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztRQUMxRCxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFRCxTQUFTLENBQUMsU0FBc0IsRUFBRSxFQUFTLEVBQUUsV0FBOEIsU0FBUyxFQUFFLFFBQWUsU0FBUztRQUMxRyxJQUFHLE9BQU8sS0FBSyxLQUFLLFdBQVcsRUFBQztZQUM1QixLQUFLLEdBQUcsU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ25DO1FBQ0QsT0FBTztZQUNILEVBQUU7WUFDRixRQUFRO1lBQ1IsT0FBTyxFQUFFLDRCQUFvQjtZQUM3QixLQUFLO1lBQ0wsTUFBTSxFQUFFLFNBQVMsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1NBQ3hDLENBQUE7SUFDTCxDQUFDO0lBRUQsV0FBVyxDQUFDLEtBQVksRUFBRSxNQUFtQjtRQUN6QyxNQUFNLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxLQUFLLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0NBQ0o7QUExSUQsc0NBMElDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAcGFja2FnZURvY3VtZW50YXRpb25cbiAqIEBtb2R1bGUgVXRpbHMtU2VyaWFsaXphdGlvblxuICovXG5pbXBvcnQgQmluVG9vbHMgZnJvbSAnLi4vdXRpbHMvYmludG9vbHMnO1xuaW1wb3J0IEJOIGZyb20gJ2JuLmpzJztcbmltcG9ydCB7IEJ1ZmZlciB9IGZyb20gJ2J1ZmZlci8nO1xuaW1wb3J0IHsgTm9kZUlEU3RyaW5nVG9CdWZmZXIsIHByaXZhdGVLZXlTdHJpbmdUb0J1ZmZlciwgYnVmZmVyVG9Ob2RlSURTdHJpbmcsIGJ1ZmZlclRvUHJpdmF0ZUtleVN0cmluZyB9IGZyb20gJy4vaGVscGVyZnVuY3Rpb25zJztcblxuZXhwb3J0IGNvbnN0IFNFUklBTElaQVRJT05WRVJTSU9OID0gMDtcblxuZXhwb3J0IHR5cGUgU2VyaWFsaXplZFR5cGUgPSBcbiAgJ2hleCcgXG58ICdCTicgXG58ICdCdWZmZXInIFxufCAnYmVjaDMyJyBcbnwgJ25vZGVJRCdcbnwgJ3ByaXZhdGVLZXknXG58ICdjYjU4JyBcbnwgJ2Jhc2U1OCcgXG58ICdiYXNlNjQnIFxufCAnZGVjaW1hbFN0cmluZydcbnwgJ251bWJlcidcbnwgJ3V0ZjgnXG47XG5cbmV4cG9ydCB0eXBlIFNlcmlhbGl6ZWRFbmNvZGluZyA9IFxuICAnaGV4JyBcbnwgJ2NiNTgnIFxufCAnYmFzZTU4JyBcbnwgJ2Jhc2U2NCcgXG58ICdkZWNpbWFsU3RyaW5nJ1xufCAnbnVtYmVyJ1xufCAndXRmOCdcbnwgJ2Rpc3BsYXknXG47XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTZXJpYWxpemFibGUge1xuICAgIHByb3RlY3RlZCBfdHlwZU5hbWU6c3RyaW5nID0gdW5kZWZpbmVkO1xuICAgIHByb3RlY3RlZCBfdHlwZUlEOm51bWJlciA9IHVuZGVmaW5lZDtcbiAgICBwcm90ZWN0ZWQgX2NvZGVjSUQ6IG51bWJlciA9IHVuZGVmaW5lZDtcblxuICAgIC8qKlxuICAgICAqIFVzZWQgaW4gc2VyaWFsaXphdGlvbi4gVHlwZU5hbWUgaXMgYSBzdHJpbmcgbmFtZSBmb3IgdGhlIHR5cGUgb2Ygb2JqZWN0IGJlaW5nIG91dHB1dC5cbiAgICAgKi9cbiAgICBnZXRUeXBlTmFtZSgpOnN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl90eXBlTmFtZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVc2VkIGluIHNlcmlhbGl6YXRpb24uIE9wdGlvbmFsLiBUeXBlSUQgaXMgYSBudW1iZXIgZm9yIHRoZSB0eXBlSUQgb2Ygb2JqZWN0IGJlaW5nIG91dHB1dC5cbiAgICAgKi9cbiAgICBnZXRUeXBlSUQoKTpudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5fdHlwZUlEXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXNlZCBpbiBzZXJpYWxpemF0aW9uLiBPcHRpb25hbC4gVHlwZUlEIGlzIGEgbnVtYmVyIGZvciB0aGUgdHlwZUlEIG9mIG9iamVjdCBiZWluZyBvdXRwdXQuXG4gICAgICovXG4gICAgZ2V0Q29kZWNJRCgpOiBudW1iZXIge1xuICAgICAgcmV0dXJuIHRoaXMuX2NvZGVjSURcbiAgICB9XG5cbiAgICAvL3NvbWV0aW1lcyB0aGUgcGFyZW50IGNsYXNzIG1hbmFnZXMgdGhlIGZpZWxkc1xuICAgIC8vdGhlc2UgYXJlIHNvIHlvdSBjYW4gc2F5IHN1cGVyLnNlcmlhbGl6ZShlbmNvZGluZyk7IFxuICAgIHNlcmlhbGl6ZShlbmNvZGluZz86U2VyaWFsaXplZEVuY29kaW5nKTpvYmplY3Qge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgXCJfdHlwZU5hbWVcIjogdGhpcy5fdHlwZU5hbWUsXG4gICAgICAgICAgICBcIl90eXBlSURcIjogKHR5cGVvZiB0aGlzLl90eXBlSUQgPT09IFwidW5kZWZpbmVkXCIgPyBudWxsIDogdGhpcy5fdHlwZUlEKSxcbiAgICAgICAgICAgIFwiX2NvZGVjSURcIjogKHR5cGVvZiB0aGlzLl9jb2RlY0lEID09PSBcInVuZGVmaW5lZFwiID8gbnVsbCA6IHRoaXMuX2NvZGVjSUQpXG4gICAgICAgIH1cbiAgICB9OyBcbiAgICBkZXNlcmlhbGl6ZShmaWVsZHM6b2JqZWN0LCBlbmNvZGluZz86U2VyaWFsaXplZEVuY29kaW5nKSB7XG4gICAgICAgIGlmKHR5cGVvZiBmaWVsZHNbXCJfdHlwZU5hbWVcIl0gIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmRlc2VyaWFsaXplOiBfdHlwZU5hbWUgbXVzdCBiZSBhIHN0cmluZywgZm91bmQ6IFwiICsgdHlwZW9mIGZpZWxkc1tcIl90eXBlTmFtZVwiXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYoZmllbGRzW1wiX3R5cGVOYW1lXCJdICE9PSB0aGlzLl90eXBlTmFtZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgLSBTZXJpYWxpemFibGUuZGVzZXJpYWxpemU6IF90eXBlTmFtZSBtaXNtYXRjaCAtLSBleHBlY3RlZDogXCIgKyB0aGlzLl90eXBlTmFtZSArIFwiIC0tIHJlY2lldmVkOiBcIiArIGZpZWxkc1tcIl90eXBlTmFtZVwiXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYodHlwZW9mIGZpZWxkc1tcIl90eXBlSURcIl0gIT09IFwidW5kZWZpbmVkXCIgJiYgZmllbGRzW1wiX3R5cGVJRFwiXSAhPT0gbnVsbCkge1xuICAgICAgICAgICAgaWYodHlwZW9mIGZpZWxkc1tcIl90eXBlSURcIl0gIT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFcnJvciAtIFNlcmlhbGl6YWJsZS5kZXNlcmlhbGl6ZTogX3R5cGVJRCBtdXN0IGJlIGEgbnVtYmVyLCBmb3VuZDogXCIgKyB0eXBlb2YgZmllbGRzW1wiX3R5cGVJRFwiXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZihmaWVsZHNbXCJfdHlwZUlEXCJdICE9PSB0aGlzLl90eXBlSUQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFcnJvciAtIFNlcmlhbGl6YWJsZS5kZXNlcmlhbGl6ZTogX3R5cGVJRCBtaXNtYXRjaCAtLSBleHBlY3RlZDogXCIgKyB0aGlzLl90eXBlSUQgKyBcIiAtLSByZWNpZXZlZDogXCIgKyBmaWVsZHNbXCJfdHlwZUlEXCJdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZih0eXBlb2YgZmllbGRzW1wiX2NvZGVjSURcIl0gIT09IFwidW5kZWZpbmVkXCIgJiYgZmllbGRzW1wiX2NvZGVjSURcIl0gIT09IG51bGwpIHtcbiAgICAgICAgICAgIGlmKHR5cGVvZiBmaWVsZHNbXCJfY29kZWNJRFwiXSAhPT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIC0gU2VyaWFsaXphYmxlLmRlc2VyaWFsaXplOiBfY29kZWNJRCBtdXN0IGJlIGEgbnVtYmVyLCBmb3VuZDogXCIgKyB0eXBlb2YgZmllbGRzW1wiX2NvZGVjSURcIl0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYoZmllbGRzW1wiX2NvZGVjSURcIl0gIT09IHRoaXMuX2NvZGVjSUQpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJFcnJvciAtIFNlcmlhbGl6YWJsZS5kZXNlcmlhbGl6ZTogX2NvZGVjSUQgbWlzbWF0Y2ggLS0gZXhwZWN0ZWQ6IFwiICsgdGhpcy5fY29kZWNJRCArIFwiIC0tIHJlY2lldmVkOiBcIiArIGZpZWxkc1tcIl9jb2RlY0lEXCJdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG59XG5cbmV4cG9ydCBjbGFzcyBTZXJpYWxpemF0aW9uIHtcbiAgICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTpTZXJpYWxpemF0aW9uO1xuICBcbiAgICBwcml2YXRlIGNvbnN0cnVjdG9yKCkge1xuICAgICAgdGhpcy5iaW50b29scyA9IEJpblRvb2xzLmdldEluc3RhbmNlKCk7XG4gICAgfVxuICAgIHByaXZhdGUgYmludG9vbHM6QmluVG9vbHM7XG5cbiAgICAvKipcbiAgICAgKiBSZXRyaWV2ZXMgdGhlIFNlcmlhbGl6YXRpb24gc2luZ2xldG9uLlxuICAgICAqL1xuICAgIHN0YXRpYyBnZXRJbnN0YW5jZSgpOiBTZXJpYWxpemF0aW9uIHtcbiAgICAgICAgaWYgKCFTZXJpYWxpemF0aW9uLmluc3RhbmNlKSB7XG4gICAgICAgICAgICBTZXJpYWxpemF0aW9uLmluc3RhbmNlID0gbmV3IFNlcmlhbGl6YXRpb24oKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gU2VyaWFsaXphdGlvbi5pbnN0YW5jZTtcbiAgICB9XG5cbiAgICBidWZmZXJUb1R5cGUodmI6QnVmZmVyLCB0eXBlOlNlcmlhbGl6ZWRUeXBlLCAuLi5hcmdzOkFycmF5PGFueT4pOmFueSB7XG4gICAgICAgIGlmKHR5cGUgPT09IFwiQk5cIikge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBCTih2Yi50b1N0cmluZyhcImhleFwiKSwgXCJoZXhcIik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcIkJ1ZmZlclwiKSB7XG4gICAgICAgICAgICBpZihhcmdzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBhcmdzWzBdID09PSBcIm51bWJlclwiKXtcbiAgICAgICAgICAgICAgICB2YiA9IEJ1ZmZlci5mcm9tKHZiLnRvU3RyaW5nKFwiaGV4XCIpLnBhZFN0YXJ0KGFyZ3NbMF0gKiAyLCAnMCcpLCBcImhleFwiKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHZiO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiZWNoMzJcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuYWRkcmVzc1RvU3RyaW5nKGFyZ3NbMF0sIGFyZ3NbMV0sIHZiKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwibm9kZUlEXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBidWZmZXJUb05vZGVJRFN0cmluZyh2Yik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcInByaXZhdGVLZXlcIikge1xuICAgICAgICAgICAgcmV0dXJuIGJ1ZmZlclRvUHJpdmF0ZUtleVN0cmluZyh2Yik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImNiNThcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuY2I1OEVuY29kZSh2Yik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImJhc2U1OFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5iaW50b29scy5idWZmZXJUb0I1OCh2Yik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImJhc2U2NFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdmIudG9TdHJpbmcoXCJiYXNlNjRcIik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImhleFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdmIudG9TdHJpbmcoXCJoZXhcIik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImRlY2ltYWxTdHJpbmdcIikge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBCTih2Yi50b1N0cmluZyhcImhleFwiKSwgXCJoZXhcIikudG9TdHJpbmcoMTApO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBCTih2Yi50b1N0cmluZyhcImhleFwiKSwgXCJoZXhcIikudG9OdW1iZXIoKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwidXRmOFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdmIudG9TdHJpbmcoXCJ1dGY4XCIpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgdHlwZVRvQnVmZmVyKHY6YW55LCB0eXBlOlNlcmlhbGl6ZWRUeXBlLCAuLi5hcmdzOkFycmF5PGFueT4pOkJ1ZmZlciB7XG4gICAgICAgIGlmKHR5cGUgPT09IFwiQk5cIikge1xuICAgICAgICAgICAgbGV0IHN0cjpzdHJpbmcgPSAodiBhcyBCTikudG9TdHJpbmcoXCJoZXhcIik7XG4gICAgICAgICAgICBpZihhcmdzLmxlbmd0aCA9PSAxICYmIHR5cGVvZiBhcmdzWzBdID09PSBcIm51bWJlclwiKXtcbiAgICAgICAgICAgICAgIHJldHVybiBCdWZmZXIuZnJvbShzdHIucGFkU3RhcnQoYXJnc1swXSAqIDIsICcwJyksICdoZXgnKTsgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20oc3RyLCAnaGV4Jyk7IFxuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJCdWZmZXJcIikge1xuICAgICAgICAgICAgcmV0dXJuIHY7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImJlY2gzMlwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5iaW50b29scy5zdHJpbmdUb0FkZHJlc3Modik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcIm5vZGVJRFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gTm9kZUlEU3RyaW5nVG9CdWZmZXIodik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcInByaXZhdGVLZXlcIikge1xuICAgICAgICAgICAgcmV0dXJuIHByaXZhdGVLZXlTdHJpbmdUb0J1ZmZlcih2KTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiY2I1OFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5iaW50b29scy5jYjU4RGVjb2RlKHYpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJiYXNlNThcIikge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmludG9vbHMuYjU4VG9CdWZmZXIodik7XG4gICAgICAgIH0gZWxzZSBpZih0eXBlID09PSBcImJhc2U2NFwiKSB7XG4gICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20odiBhcyBzdHJpbmcsIFwiYmFzZTY0XCIpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJoZXhcIikge1xuICAgICAgICAgICAgaWYoKHYgYXMgc3RyaW5nKS5zdGFydHNXaXRoKFwiMHhcIikpe1xuICAgICAgICAgICAgICAgIHYgPSAodiBhcyBzdHJpbmcpLnNsaWNlKDIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHYgYXMgc3RyaW5nLCBcImhleFwiKTtcbiAgICAgICAgfSBlbHNlIGlmKHR5cGUgPT09IFwiZGVjaW1hbFN0cmluZ1wiKSB7XG4gICAgICAgICAgICBsZXQgc3RyOnN0cmluZyA9IG5ldyBCTih2IGFzIHN0cmluZywgMTApLnRvU3RyaW5nKFwiaGV4XCIpO1xuICAgICAgICAgICAgaWYoYXJncy5sZW5ndGggPT0gMSAmJiB0eXBlb2YgYXJnc1swXSA9PT0gXCJudW1iZXJcIil7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHN0ci5wYWRTdGFydChhcmdzWzBdICogMiwgJzAnKSwgJ2hleCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHN0ciwgJ2hleCcpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJudW1iZXJcIikge1xuICAgICAgICAgICAgbGV0IHN0cjpzdHJpbmcgPSBuZXcgQk4odiwgMTApLnRvU3RyaW5nKFwiaGV4XCIpO1xuICAgICAgICAgICAgaWYoYXJncy5sZW5ndGggPT0gMSAmJiB0eXBlb2YgYXJnc1swXSA9PT0gXCJudW1iZXJcIil7XG4gICAgICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHN0ci5wYWRTdGFydChhcmdzWzBdICogMiwgJzAnKSwgJ2hleCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIEJ1ZmZlci5mcm9tKHN0ciwgJ2hleCcpO1xuICAgICAgICB9IGVsc2UgaWYodHlwZSA9PT0gXCJ1dGY4XCIpIHtcbiAgICAgICAgICAgIGlmKGFyZ3MubGVuZ3RoID09IDEgJiYgdHlwZW9mIGFyZ3NbMF0gPT09IFwibnVtYmVyXCIpe1xuICAgICAgICAgICAgICAgIGxldCBiOkJ1ZmZlciA9IEJ1ZmZlci5hbGxvYyhhcmdzWzBdKTtcbiAgICAgICAgICAgICAgICBiLndyaXRlKHYpXG4gICAgICAgICAgICAgICAgcmV0dXJuIGI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gQnVmZmVyLmZyb20odiwgJ3V0ZjgnKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGVuY29kZXIodmFsdWU6YW55LCBlbmNvZGluZzpTZXJpYWxpemVkRW5jb2RpbmcsIGludHlwZTpTZXJpYWxpemVkVHlwZSwgb3V0dHlwZTpTZXJpYWxpemVkVHlwZSwgLi4uYXJnczpBcnJheTxhbnk+KTpzdHJpbmcge1xuICAgICAgICBpZih0eXBlb2YgdmFsdWUgPT09IFwidW5kZWZpbmVkXCIpe1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgLSBTZXJpYWxpemFibGUuZW5jb2RlcjogdmFsdWUgcGFzc2VkIGlzIHVuZGVmaW5lZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZihlbmNvZGluZyAhPT0gXCJkaXNwbGF5XCIpe1xuICAgICAgICAgICAgb3V0dHlwZSA9IGVuY29kaW5nO1xuICAgICAgICB9XG4gICAgICAgIGxldCB2YjpCdWZmZXIgPSB0aGlzLnR5cGVUb0J1ZmZlcih2YWx1ZSwgaW50eXBlLCAuLi5hcmdzKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnVmZmVyVG9UeXBlKHZiLCBvdXR0eXBlLCAuLi5hcmdzKTtcbiAgICB9XG5cblxuICAgIGRlY29kZXIodmFsdWU6c3RyaW5nLCBlbmNvZGluZzpTZXJpYWxpemVkRW5jb2RpbmcsIGludHlwZTpTZXJpYWxpemVkVHlwZSwgb3V0dHlwZTpTZXJpYWxpemVkVHlwZSwgLi4uYXJnczpBcnJheTxhbnk+KTphbnkge1xuICAgICAgICBpZih0eXBlb2YgdmFsdWUgPT09IFwidW5kZWZpbmVkXCIpe1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgLSBTZXJpYWxpemFibGUuZGVjb2RlcjogdmFsdWUgcGFzc2VkIGlzIHVuZGVmaW5lZFwiKTtcbiAgICAgICAgfVxuICAgICAgICBpZihlbmNvZGluZyAhPT0gXCJkaXNwbGF5XCIpIHtcbiAgICAgICAgICAgIGludHlwZSA9IGVuY29kaW5nO1xuICAgICAgICB9IFxuICAgICAgICBsZXQgdmI6QnVmZmVyID0gdGhpcy50eXBlVG9CdWZmZXIodmFsdWUsIGludHlwZSwgLi4uYXJncyk7XG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZmZlclRvVHlwZSh2Yiwgb3V0dHlwZSwgLi4uYXJncyk7XG4gICAgfVxuXG4gICAgc2VyaWFsaXplKHNlcmlhbGl6ZTpTZXJpYWxpemFibGUsIHZtOnN0cmluZywgZW5jb2Rpbmc6U2VyaWFsaXplZEVuY29kaW5nID0gXCJkaXNwbGF5XCIsIG5vdGVzOnN0cmluZyA9IHVuZGVmaW5lZCk6b2JqZWN0IHtcbiAgICAgICAgaWYodHlwZW9mIG5vdGVzID09PSBcInVuZGVmaW5lZFwiKXtcbiAgICAgICAgICAgIG5vdGVzID0gc2VyaWFsaXplLmdldFR5cGVOYW1lKCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHZtLFxuICAgICAgICAgICAgZW5jb2RpbmcsXG4gICAgICAgICAgICB2ZXJzaW9uOiBTRVJJQUxJWkFUSU9OVkVSU0lPTixcbiAgICAgICAgICAgIG5vdGVzLFxuICAgICAgICAgICAgZmllbGRzOiBzZXJpYWxpemUuc2VyaWFsaXplKGVuY29kaW5nKVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZGVzZXJpYWxpemUoaW5wdXQ6b2JqZWN0LCBvdXRwdXQ6U2VyaWFsaXphYmxlKSB7XG4gICAgICAgIG91dHB1dC5kZXNlcmlhbGl6ZShpbnB1dFtcImZpZWxkc1wiXSwgaW5wdXRbXCJlbmNvZGluZ1wiXSk7XG4gICAgfVxufSJdfQ==