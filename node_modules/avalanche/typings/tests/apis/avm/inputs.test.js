"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const utxos_1 = require("src/apis/avm/utxos");
const keychain_1 = require("src/apis/avm/keychain");
const inputs_1 = require("src/apis/avm/inputs");
const create_hash_1 = __importDefault(require("create-hash"));
const bintools_1 = __importDefault(require("src/utils/bintools"));
const bn_js_1 = __importDefault(require("bn.js"));
const buffer_1 = require("buffer/");
const outputs_1 = require("src/apis/avm/outputs");
const constants_1 = require("src/apis/avm/constants");
const input_1 = require("src/common/input");
/**
 * @ignore
 */
const bintools = bintools_1.default.getInstance();
describe('Inputs', () => {
    let set;
    let keymgr1;
    let keymgr2;
    let addrs1;
    let addrs2;
    let utxos;
    let hrp = "tests";
    const amnt = 10000;
    const codecID_zero = 0;
    const codecID_one = 1;
    beforeEach(() => {
        set = new utxos_1.UTXOSet();
        keymgr1 = new keychain_1.KeyChain(hrp, 'X');
        keymgr2 = new keychain_1.KeyChain(hrp, 'X');
        addrs1 = [];
        addrs2 = [];
        utxos = [];
        for (let i = 0; i < 3; i++) {
            addrs1.push(keymgr1.makeKey().getAddress());
            addrs2.push(keymgr2.makeKey().getAddress());
        }
        const amount = new bn_js_1.default(amnt);
        const addresses = keymgr1.getAddresses();
        const locktime = new bn_js_1.default(54321);
        const threshold = 3;
        for (let i = 0; i < 3; i++) {
            const txid = buffer_1.Buffer.from(create_hash_1.default('sha256').update(bintools.fromBNToBuffer(new bn_js_1.default(i), 32)).digest());
            const txidx = buffer_1.Buffer.from(bintools.fromBNToBuffer(new bn_js_1.default(i), 4));
            const assetID = buffer_1.Buffer.from(create_hash_1.default('sha256').update(txid).digest());
            const out = new outputs_1.SECPTransferOutput(amount.add(new bn_js_1.default(i)), addresses, locktime, threshold);
            const xferout = new outputs_1.TransferableOutput(assetID, out);
            const u = new utxos_1.UTXO(constants_1.AVMConstants.LATESTCODEC, txid, txidx, assetID, out);
            u.fromBuffer(buffer_1.Buffer.concat([u.getCodecIDBuffer(), txid, txidx, xferout.toBuffer()]));
            utxos.push(u);
        }
        set.addArray(utxos);
    });
    test('SECPInput', () => {
        let u;
        let txid;
        let txidx;
        const amount = new bn_js_1.default(amnt);
        let input;
        let xferinput;
        u = utxos[0];
        txid = u.getTxID();
        txidx = u.getOutputIdx();
        const asset = u.getAssetID();
        input = new inputs_1.SECPTransferInput(amount);
        xferinput = new inputs_1.TransferableInput(txid, txidx, asset, input);
        expect(xferinput.getUTXOID()).toBe(u.getUTXOID());
        expect(input.getInputID()).toBe(constants_1.AVMConstants.SECPINPUTID);
        input.addSignatureIdx(0, addrs2[0]);
        input.addSignatureIdx(1, addrs2[1]);
        const newin = new inputs_1.SECPTransferInput();
        newin.fromBuffer(bintools.b58ToBuffer(input.toString()));
        expect(newin.toBuffer().toString('hex')).toBe(input.toBuffer().toString('hex'));
        expect(newin.getSigIdxs().toString()).toBe(input.getSigIdxs().toString());
    });
    test('Input comparator', () => {
        const inpt1 = new inputs_1.SECPTransferInput(utxos[0].getOutput().getAmount());
        const inpt2 = new inputs_1.SECPTransferInput(utxos[1].getOutput().getAmount());
        const inpt3 = new inputs_1.SECPTransferInput(utxos[2].getOutput().getAmount());
        const cmp = input_1.Input.comparator();
        expect(cmp(inpt1, inpt2)).toBe(-1);
        expect(cmp(inpt1, inpt3)).toBe(-1);
        expect(cmp(inpt1, inpt1)).toBe(0);
        expect(cmp(inpt2, inpt2)).toBe(0);
        expect(cmp(inpt3, inpt3)).toBe(0);
    });
    test('TransferableInput comparator', () => {
        const inpt1 = new inputs_1.SECPTransferInput(utxos[0].getOutput().getAmount());
        const in1 = new inputs_1.TransferableInput(utxos[0].getTxID(), utxos[0].getOutputIdx(), utxos[0].getAssetID(), inpt1);
        const inpt2 = new inputs_1.SECPTransferInput(utxos[1].getOutput().getAmount());
        const in2 = new inputs_1.TransferableInput(utxos[1].getTxID(), utxos[1].getOutputIdx(), utxos[1].getAssetID(), inpt2);
        const inpt3 = new inputs_1.SECPTransferInput(utxos[2].getOutput().getAmount());
        const in3 = new inputs_1.TransferableInput(utxos[2].getTxID(), utxos[2].getOutputIdx(), utxos[2].getAssetID(), inpt3);
        const cmp = inputs_1.TransferableInput.comparator();
        expect(cmp(in1, in2)).toBe(-1);
        expect(cmp(in1, in3)).toBe(-1);
        expect(cmp(in1, in1)).toBe(0);
        expect(cmp(in2, in2)).toBe(0);
        expect(cmp(in3, in3)).toBe(0);
    });
    test('SECPTransferInput codecIDs', () => {
        const secpTransferInput = new inputs_1.SECPTransferInput(utxos[0].getOutput().getAmount());
        expect(secpTransferInput.getCodecID()).toBe(codecID_zero);
        expect(secpTransferInput.getInputID()).toBe(constants_1.AVMConstants.SECPINPUTID);
        secpTransferInput.setCodecID(codecID_one);
        expect(secpTransferInput.getCodecID()).toBe(codecID_one);
        expect(secpTransferInput.getInputID()).toBe(constants_1.AVMConstants.SECPINPUTID_CODECONE);
        secpTransferInput.setCodecID(codecID_zero);
        expect(secpTransferInput.getCodecID()).toBe(codecID_zero);
        expect(secpTransferInput.getInputID()).toBe(constants_1.AVMConstants.SECPINPUTID);
    });
    test("Invalid SECPTransferInput codecID", () => {
        const secpTransferInput = new inputs_1.SECPTransferInput(utxos[0].getOutput().getAmount());
        expect(() => {
            secpTransferInput.setCodecID(2);
        }).toThrow("Error - SECPTransferInput.setCodecID: codecID 2, is not valid. Valid codecIDs are 0 and 1.");
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5wdXRzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi90ZXN0cy9hcGlzL2F2bS9pbnB1dHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLDhDQUFtRDtBQUNuRCxvREFBaUQ7QUFDakQsZ0RBQTJFO0FBQzNFLDhEQUFxQztBQUNyQyxrRUFBMEM7QUFDMUMsa0RBQXVCO0FBQ3ZCLG9DQUFpQztBQUNqQyxrREFFOEI7QUFDOUIsc0RBQXNEO0FBQ3RELDRDQUF5QztBQUd6Qzs7R0FFRztBQUNILE1BQU0sUUFBUSxHQUFHLGtCQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDeEMsUUFBUSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUU7SUFDdEIsSUFBSSxHQUFXLENBQUM7SUFDaEIsSUFBSSxPQUFnQixDQUFDO0lBQ3JCLElBQUksT0FBZ0IsQ0FBQztJQUNyQixJQUFJLE1BQW9CLENBQUM7SUFDekIsSUFBSSxNQUFvQixDQUFDO0lBQ3pCLElBQUksS0FBaUIsQ0FBQztJQUN0QixJQUFJLEdBQUcsR0FBVSxPQUFPLENBQUM7SUFDekIsTUFBTSxJQUFJLEdBQVUsS0FBSyxDQUFDO0lBQzFCLE1BQU0sWUFBWSxHQUFXLENBQUMsQ0FBQztJQUMvQixNQUFNLFdBQVcsR0FBVyxDQUFDLENBQUM7SUFDOUIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLEdBQUcsR0FBRyxJQUFJLGVBQU8sRUFBRSxDQUFDO1FBQ3BCLE9BQU8sR0FBRyxJQUFJLG1CQUFRLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLE9BQU8sR0FBRyxJQUFJLG1CQUFRLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQ2pDLE1BQU0sR0FBRyxFQUFFLENBQUM7UUFDWixNQUFNLEdBQUcsRUFBRSxDQUFDO1FBQ1osS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUNYLEtBQUssSUFBSSxDQUFDLEdBQVUsQ0FBQyxFQUFF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QyxDQUFDO0lBQ3hFLENBQUMsQ0FBQyxDQUFDO0lBRUgsSUFBSSxDQUFDLG1DQUFtQyxFQUFFLEdBQVMsRUFBRTtRQUNuRCxNQUFNLGlCQUFpQixHQUFzQixJQUFJLDBCQUFpQixDQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQW1CLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUN2SCxNQUFNLENBQUMsR0FBRyxFQUFFO1lBQ1YsaUJBQWlCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ2pDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyw0RkFBNEYsQ0FBQyxDQUFDO0lBQzNHLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBVVFhPU2V0LCBVVFhPIH0gZnJvbSAnc3JjL2FwaXMvYXZtL3V0eG9zJztcbmltcG9ydCB7IEtleUNoYWluIH0gZnJvbSAnc3JjL2FwaXMvYXZtL2tleWNoYWluJztcbmltcG9ydCB7IFNFQ1BUcmFuc2ZlcklucHV0LCBUcmFuc2ZlcmFibGVJbnB1dCB9IGZyb20gJ3NyYy9hcGlzL2F2bS9pbnB1dHMnO1xuaW1wb3J0IGNyZWF0ZUhhc2ggZnJvbSAnY3JlYXRlLWhhc2gnO1xuaW1wb3J0IEJpblRvb2xzIGZyb20gJ3NyYy91dGlscy9iaW50b29scyc7XG5pbXBvcnQgQk4gZnJvbSAnYm4uanMnO1xuaW1wb3J0IHsgQnVmZmVyIH0gZnJvbSAnYnVmZmVyLyc7XG5pbXBvcnQge1xuICBTRUNQVHJhbnNmZXJPdXRwdXQsIEFtb3VudE91dHB1dCwgVHJhbnNmZXJhYmxlT3V0cHV0LFxufSBmcm9tICdzcmMvYXBpcy9hdm0vb3V0cHV0cyc7XG5pbXBvcnQgeyBBVk1Db25zdGFudHMgfSBmcm9tICdzcmMvYXBpcy9hdm0vY29uc3RhbnRzJztcbmltcG9ydCB7IElucHV0IH0gZnJvbSAnc3JjL2NvbW1vbi9pbnB1dCc7XG5pbXBvcnQgeyBPdXRwdXQgfSBmcm9tICdzcmMvY29tbW9uL291dHB1dCc7XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5jb25zdCBiaW50b29scyA9IEJpblRvb2xzLmdldEluc3RhbmNlKCk7XG5kZXNjcmliZSgnSW5wdXRzJywgKCkgPT4ge1xuICBsZXQgc2V0OlVUWE9TZXQ7XG4gIGxldCBrZXltZ3IxOktleUNoYWluO1xuICBsZXQga2V5bWdyMjpLZXlDaGFpbjtcbiAgbGV0IGFkZHJzMTpBcnJheTxCdWZmZXI+O1xuICBsZXQgYWRkcnMyOkFycmF5PEJ1ZmZlcj47XG4gIGxldCB1dHhvczpBcnJheTxVVFhPPjtcbiAgbGV0IGhycDpzdHJpbmcgPSBcInRlc3RzXCI7XG4gIGNvbnN0IGFtbnQ6bnVtYmVyID0gMTAwMDA7XG4gIGNvbnN0IGNvZGVjSURfemVybzogbnVtYmVyID0gMDtcbiAgY29uc3QgY29kZWNJRF9vbmU6IG51bWJlciA9IDE7XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIHNldCA9IG5ldyBVVFhPU2V0KCk7XG4gICAga2V5bWdyMSA9IG5ldyBLZXlDaGFpbihocnAsICdYJyk7XG4gICAga2V5bWdyMiA9IG5ldyBLZXlDaGFpbihocnAsICdYJyk7XG4gICAgYWRkcnMxID0gW107XG4gICAgYWRkcnMyID0gW107XG4gICAgdXR4b3MgPSBbXTtcbiAgICBmb3IgKGxldCBpOm51bWJlciA9IDA7IGkgPCAzOyBpKyspIHtcbiAgICAgIGFkZHJzMS5wdXNoKGtleW1ncjEubWFrZUtleSgpLmdldEFkZHJlc3MoKSk7XG4gICAgICBhZGRyczIucHVzaChrZXltZ3IyLm1ha2VLZXkoKS5nZXRBZGRyZXNzKCkpO1xuICAgIH1cbiAgICBjb25zdCBhbW91bnQ6Qk4gPSBuZXcgQk4oYW1udCk7XG4gICAgY29uc3QgYWRkcmVzc2VzOkFycmF5PEJ1ZmZlcj4gPSBrZXltZ3IxLmdldEFkZHJlc3NlcygpO1xuICAgIGNvbnN0IGxvY2t0aW1lOkJOID0gbmV3IEJOKDU0MzIxKTtcbiAgICBjb25zdCB0aHJlc2hvbGQ6bnVtYmVyID0gMztcblxuICAgIGZvciAobGV0IGk6bnVtYmVyID0gMDsgaSA8IDM7IGkrKykge1xuICAgICAgY29uc3QgdHhpZDpCdWZmZXIgPSBCdWZmZXIuZnJvbShjcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUoYmludG9vbHMuZnJvbUJOVG9CdWZmZXIobmV3IEJOKGkpLCAzMikpLmRpZ2VzdCgpKTtcbiAgICAgIGNvbnN0IHR4aWR4OkJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGJpbnRvb2xzLmZyb21CTlRvQnVmZmVyKG5ldyBCTihpKSwgNCkpO1xuICAgICAgY29uc3QgYXNzZXRJRDpCdWZmZXIgPSBCdWZmZXIuZnJvbShjcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUodHhpZCkuZGlnZXN0KCkpO1xuICAgICAgY29uc3Qgb3V0Ok91dHB1dCA9IG5ldyBTRUNQVHJhbnNmZXJPdXRwdXQoYW1vdW50LmFkZChuZXcgQk4oaSkpLCBhZGRyZXNzZXMsIGxvY2t0aW1lLCB0aHJlc2hvbGQpO1xuICAgICAgY29uc3QgeGZlcm91dDpUcmFuc2ZlcmFibGVPdXRwdXQgPSBuZXcgVHJhbnNmZXJhYmxlT3V0cHV0KGFzc2V0SUQsIG91dCk7XG4gICAgICBjb25zdCB1OlVUWE8gPSBuZXcgVVRYTyhBVk1Db25zdGFudHMuTEFURVNUQ09ERUMsIHR4aWQsIHR4aWR4LCBhc3NldElELCBvdXQpO1xuICAgICAgdS5mcm9tQnVmZmVyKEJ1ZmZlci5jb25jYXQoW3UuZ2V0Q29kZWNJREJ1ZmZlcigpLCB0eGlkLCB0eGlkeCwgeGZlcm91dC50b0J1ZmZlcigpXSkpO1xuICAgICAgdXR4b3MucHVzaCh1KTtcbiAgICB9XG4gICAgc2V0LmFkZEFycmF5KHV0eG9zKTtcbiAgfSk7XG4gIHRlc3QoJ1NFQ1BJbnB1dCcsICgpID0+IHtcbiAgICBsZXQgdTpVVFhPO1xuICAgIGxldCB0eGlkOkJ1ZmZlcjtcbiAgICBsZXQgdHhpZHg6QnVmZmVyO1xuICAgIGNvbnN0IGFtb3VudDpCTiA9IG5ldyBCTihhbW50KTtcbiAgICBsZXQgaW5wdXQ6U0VDUFRyYW5zZmVySW5wdXQ7XG4gICAgbGV0IHhmZXJpbnB1dDpUcmFuc2ZlcmFibGVJbnB1dDtcblxuICAgIHUgPSB1dHhvc1swXTtcbiAgICB0eGlkID0gdS5nZXRUeElEKCk7XG4gICAgdHhpZHggPSB1LmdldE91dHB1dElkeCgpO1xuICAgIGNvbnN0IGFzc2V0ID0gdS5nZXRBc3NldElEKCk7XG5cbiAgICBpbnB1dCA9IG5ldyBTRUNQVHJhbnNmZXJJbnB1dChhbW91bnQpO1xuICAgIHhmZXJpbnB1dCA9IG5ldyBUcmFuc2ZlcmFibGVJbnB1dCh0eGlkLCB0eGlkeCwgYXNzZXQsIGlucHV0KTtcbiAgICBleHBlY3QoeGZlcmlucHV0LmdldFVUWE9JRCgpKS50b0JlKHUuZ2V0VVRYT0lEKCkpO1xuICAgIGV4cGVjdChpbnB1dC5nZXRJbnB1dElEKCkpLnRvQmUoQVZNQ29uc3RhbnRzLlNFQ1BJTlBVVElEKTtcblxuICAgIGlucHV0LmFkZFNpZ25hdHVyZUlkeCgwLCBhZGRyczJbMF0pO1xuICAgIGlucHV0LmFkZFNpZ25hdHVyZUlkeCgxLCBhZGRyczJbMV0pO1xuXG4gICAgY29uc3QgbmV3aW46U0VDUFRyYW5zZmVySW5wdXQgPSBuZXcgU0VDUFRyYW5zZmVySW5wdXQoKTtcbiAgICBuZXdpbi5mcm9tQnVmZmVyKGJpbnRvb2xzLmI1OFRvQnVmZmVyKGlucHV0LnRvU3RyaW5nKCkpKTtcbiAgICBleHBlY3QobmV3aW4udG9CdWZmZXIoKS50b1N0cmluZygnaGV4JykpLnRvQmUoaW5wdXQudG9CdWZmZXIoKS50b1N0cmluZygnaGV4JykpO1xuICAgIGV4cGVjdChuZXdpbi5nZXRTaWdJZHhzKCkudG9TdHJpbmcoKSkudG9CZShpbnB1dC5nZXRTaWdJZHhzKCkudG9TdHJpbmcoKSk7XG4gIH0pO1xuXG4gIHRlc3QoJ0lucHV0IGNvbXBhcmF0b3InLCAoKSA9PiB7XG4gICAgY29uc3QgaW5wdDE6U0VDUFRyYW5zZmVySW5wdXQgPSBuZXcgU0VDUFRyYW5zZmVySW5wdXQoKHV0eG9zWzBdLmdldE91dHB1dCgpIGFzIEFtb3VudE91dHB1dCkuZ2V0QW1vdW50KCkpO1xuXG4gICAgY29uc3QgaW5wdDI6U0VDUFRyYW5zZmVySW5wdXQgPSBuZXcgU0VDUFRyYW5zZmVySW5wdXQoKHV0eG9zWzFdLmdldE91dHB1dCgpIGFzIEFtb3VudE91dHB1dCkuZ2V0QW1vdW50KCkpO1xuXG4gICAgY29uc3QgaW5wdDM6U0VDUFRyYW5zZmVySW5wdXQgPSBuZXcgU0VDUFRyYW5zZmVySW5wdXQoKHV0eG9zWzJdLmdldE91dHB1dCgpIGFzIEFtb3VudE91dHB1dCkuZ2V0QW1vdW50KCkpO1xuXG4gICAgY29uc3QgY21wID0gSW5wdXQuY29tcGFyYXRvcigpO1xuICAgIGV4cGVjdChjbXAoaW5wdDEsIGlucHQyKSkudG9CZSgtMSk7XG4gICAgZXhwZWN0KGNtcChpbnB0MSwgaW5wdDMpKS50b0JlKC0xKTtcbiAgICBleHBlY3QoY21wKGlucHQxLCBpbnB0MSkpLnRvQmUoMCk7XG4gICAgZXhwZWN0KGNtcChpbnB0MiwgaW5wdDIpKS50b0JlKDApO1xuICAgIGV4cGVjdChjbXAoaW5wdDMsIGlucHQzKSkudG9CZSgwKTtcbiAgfSk7XG5cbiAgdGVzdCgnVHJhbnNmZXJhYmxlSW5wdXQgY29tcGFyYXRvcicsICgpID0+IHtcbiAgICBjb25zdCBpbnB0MTpTRUNQVHJhbnNmZXJJbnB1dCA9IG5ldyBTRUNQVHJhbnNmZXJJbnB1dCgodXR4b3NbMF0uZ2V0T3V0cHV0KCkgYXMgQW1vdW50T3V0cHV0KS5nZXRBbW91bnQoKSk7XG4gICAgY29uc3QgaW4xOlRyYW5zZmVyYWJsZUlucHV0ID0gbmV3IFRyYW5zZmVyYWJsZUlucHV0KHV0eG9zWzBdLmdldFR4SUQoKSwgdXR4b3NbMF0uZ2V0T3V0cHV0SWR4KCksIHV0eG9zWzBdLmdldEFzc2V0SUQoKSwgaW5wdDEpO1xuXG4gICAgY29uc3QgaW5wdDI6U0VDUFRyYW5zZmVySW5wdXQgPSBuZXcgU0VDUFRyYW5zZmVySW5wdXQoKHV0eG9zWzFdLmdldE91dHB1dCgpIGFzIEFtb3VudE91dHB1dCkuZ2V0QW1vdW50KCkpO1xuICAgIGNvbnN0IGluMjpUcmFuc2ZlcmFibGVJbnB1dCA9IG5ldyBUcmFuc2ZlcmFibGVJbnB1dCh1dHhvc1sxXS5nZXRUeElEKCksIHV0eG9zWzFdLmdldE91dHB1dElkeCgpLCB1dHhvc1sxXS5nZXRBc3NldElEKCksIGlucHQyKTtcblxuICAgIGNvbnN0IGlucHQzOlNFQ1BUcmFuc2ZlcklucHV0ID0gbmV3IFNFQ1BUcmFuc2ZlcklucHV0KCh1dHhvc1syXS5nZXRPdXRwdXQoKSBhcyBBbW91bnRPdXRwdXQpLmdldEFtb3VudCgpKTtcbiAgICBjb25zdCBpbjM6VHJhbnNmZXJhYmxlSW5wdXQgPSBuZXcgVHJhbnNmZXJhYmxlSW5wdXQodXR4b3NbMl0uZ2V0VHhJRCgpLCB1dHhvc1syXS5nZXRPdXRwdXRJZHgoKSwgdXR4b3NbMl0uZ2V0QXNzZXRJRCgpLCBpbnB0Myk7XG5cbiAgICBjb25zdCBjbXAgPSBUcmFuc2ZlcmFibGVJbnB1dC5jb21wYXJhdG9yKCk7XG4gICAgZXhwZWN0KGNtcChpbjEsIGluMikpLnRvQmUoLTEpO1xuICAgIGV4cGVjdChjbXAoaW4xLCBpbjMpKS50b0JlKC0xKTtcbiAgICBleHBlY3QoY21wKGluMSwgaW4xKSkudG9CZSgwKTtcbiAgICBleHBlY3QoY21wKGluMiwgaW4yKSkudG9CZSgwKTtcbiAgICBleHBlY3QoY21wKGluMywgaW4zKSkudG9CZSgwKTtcbiAgfSk7XG5cbiAgdGVzdCgnU0VDUFRyYW5zZmVySW5wdXQgY29kZWNJRHMnLCAoKTogdm9pZCA9PiB7XG4gICAgY29uc3Qgc2VjcFRyYW5zZmVySW5wdXQ6IFNFQ1BUcmFuc2ZlcklucHV0ID0gbmV3IFNFQ1BUcmFuc2ZlcklucHV0KCh1dHhvc1swXS5nZXRPdXRwdXQoKSBhcyBBbW91bnRPdXRwdXQpLmdldEFtb3VudCgpKTtcbiAgICBleHBlY3Qoc2VjcFRyYW5zZmVySW5wdXQuZ2V0Q29kZWNJRCgpKS50b0JlKGNvZGVjSURfemVybyk7XG4gICAgZXhwZWN0KHNlY3BUcmFuc2ZlcklucHV0LmdldElucHV0SUQoKSkudG9CZShBVk1Db25zdGFudHMuU0VDUElOUFVUSUQpO1xuICAgIHNlY3BUcmFuc2ZlcklucHV0LnNldENvZGVjSUQoY29kZWNJRF9vbmUpXG4gICAgZXhwZWN0KHNlY3BUcmFuc2ZlcklucHV0LmdldENvZGVjSUQoKSkudG9CZShjb2RlY0lEX29uZSk7XG4gICAgZXhwZWN0KHNlY3BUcmFuc2ZlcklucHV0LmdldElucHV0SUQoKSkudG9CZShBVk1Db25zdGFudHMuU0VDUElOUFVUSURfQ09ERUNPTkUpO1xuICAgIHNlY3BUcmFuc2ZlcklucHV0LnNldENvZGVjSUQoY29kZWNJRF96ZXJvKVxuICAgIGV4cGVjdChzZWNwVHJhbnNmZXJJbnB1dC5nZXRDb2RlY0lEKCkpLnRvQmUoY29kZWNJRF96ZXJvKTtcbiAgICBleHBlY3Qoc2VjcFRyYW5zZmVySW5wdXQuZ2V0SW5wdXRJRCgpKS50b0JlKEFWTUNvbnN0YW50cy5TRUNQSU5QVVRJRCk7XG4gIH0pO1xuXG4gIHRlc3QoXCJJbnZhbGlkIFNFQ1BUcmFuc2ZlcklucHV0IGNvZGVjSURcIiwgKCk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IHNlY3BUcmFuc2ZlcklucHV0OiBTRUNQVHJhbnNmZXJJbnB1dCA9IG5ldyBTRUNQVHJhbnNmZXJJbnB1dCgodXR4b3NbMF0uZ2V0T3V0cHV0KCkgYXMgQW1vdW50T3V0cHV0KS5nZXRBbW91bnQoKSk7XG4gICAgZXhwZWN0KCgpID0+IHtcbiAgICAgIHNlY3BUcmFuc2ZlcklucHV0LnNldENvZGVjSUQoMilcbiAgICB9KS50b1Rocm93KFwiRXJyb3IgLSBTRUNQVHJhbnNmZXJJbnB1dC5zZXRDb2RlY0lEOiBjb2RlY0lEIDIsIGlzIG5vdCB2YWxpZC4gVmFsaWQgY29kZWNJRHMgYXJlIDAgYW5kIDEuXCIpO1xuICB9KTtcbn0pO1xuIl19