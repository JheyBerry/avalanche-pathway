"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const utxos_1 = require("src/apis/avm/utxos");
const create_hash_1 = __importDefault(require("create-hash"));
const bintools_1 = __importDefault(require("src/utils/bintools"));
const bn_js_1 = __importDefault(require("bn.js"));
const buffer_1 = require("buffer/");
const outputs_1 = require("src/apis/avm/outputs");
const constants_1 = require("src/apis/avm/constants");
const ops_1 = require("src/apis/avm/ops");
const output_1 = require("src/common/output");
const ops_2 = require("src/apis/avm/ops");
/**
 * @ignore
 */
const bintools = bintools_1.default.getInstance();
describe('Operations', () => {
    const codecID_zero = 0;
    const codecID_one = 1;
    let assetID = "8a5d2d32e68bc50036e4d086044617fe4a0a0296b274999ba568ea92da46d533";
    let assetIDBuff = buffer_1.Buffer.from(assetID, "hex");
    let addrs = [
        bintools.cb58Decode("B6D4v1VtPYLbiUvYXtW4Px8oE9imC2vGW"),
        bintools.cb58Decode("P5wdRuZeaDt28eHMP5S3w9ZdoBfo7wuzF"),
        bintools.cb58Decode("6Y3kysjF9jnHnYkdS9yGAuoHyae2eNmeV")
    ].sort();
    let locktime = new bn_js_1.default(54321);
    let payload = buffer_1.Buffer.alloc(1024);
    payload.write("All you Trekkies and TV addicts, Don't mean to diss don't mean to bring static.", 0, 1024, "utf8");
    describe('NFTMintOperation', () => {
        test('SelectOperationClass', () => {
            let goodop = new ops_1.NFTMintOperation(0, buffer_1.Buffer.from(""), []);
            let operation = ops_1.SelectOperationClass(goodop.getOperationID());
            expect(operation).toBeInstanceOf(ops_1.NFTMintOperation);
            expect(() => {
                ops_1.SelectOperationClass(99);
            }).toThrow("Error - SelectOperationClass: unknown opid");
        });
        test('comparator', () => {
            let outputOwners = [];
            outputOwners.push(new output_1.OutputOwners(addrs, locktime, 1));
            let op1 = new ops_1.NFTMintOperation(1, payload, outputOwners);
            let op2 = new ops_1.NFTMintOperation(2, payload, outputOwners);
            let op3 = new ops_1.NFTMintOperation(0, payload, outputOwners);
            let cmp = ops_1.NFTMintOperation.comparator();
            expect(cmp(op1, op1)).toBe(0);
            expect(cmp(op2, op2)).toBe(0);
            expect(cmp(op3, op3)).toBe(0);
            expect(cmp(op1, op2)).toBe(-1);
            expect(cmp(op1, op3)).toBe(1);
        });
        test('Functionality', () => {
            let outputOwners = [];
            outputOwners.push(new output_1.OutputOwners(addrs, locktime, 1));
            let op = new ops_1.NFTMintOperation(0, payload, outputOwners);
            expect(op.getOperationID()).toBe(constants_1.AVMConstants.NFTMINTOPID);
            expect(op.getOutputOwners().toString()).toBe(outputOwners.toString());
            let opcopy = new ops_1.NFTMintOperation();
            let opb = op.toBuffer();
            opcopy.fromBuffer(opb);
            expect(opcopy.toString()).toBe(op.toString());
        });
        test("NFTMintOperation codecIDs", () => {
            const outputOwners = [];
            outputOwners.push(new output_1.OutputOwners(addrs, locktime, 1));
            const nftMintOperation = new ops_1.NFTMintOperation(0, payload, outputOwners);
            expect(nftMintOperation.getCodecID()).toBe(codecID_zero);
            expect(nftMintOperation.getOperationID()).toBe(constants_1.AVMConstants.NFTMINTOPID);
            nftMintOperation.setCodecID(codecID_one);
            expect(nftMintOperation.getCodecID()).toBe(codecID_one);
            expect(nftMintOperation.getOperationID()).toBe(constants_1.AVMConstants.NFTMINTOPID_CODECONE);
            nftMintOperation.setCodecID(codecID_zero);
            expect(nftMintOperation.getCodecID()).toBe(codecID_zero);
            expect(nftMintOperation.getOperationID()).toBe(constants_1.AVMConstants.NFTMINTOPID);
        });
        test("Invalid NFTMintOperation codecID", () => {
            const outputOwners = [];
            outputOwners.push(new output_1.OutputOwners(addrs, locktime, 1));
            const nftMintOperation = new ops_1.NFTMintOperation(0, payload, outputOwners);
            expect(() => {
                nftMintOperation.setCodecID(2);
            }).toThrow("Error - NFTMintOperation.setCodecID: codecID 2, is not valid. Valid codecIDs are 0 and 1.");
        });
    });
    describe('NFTTransferOperation', () => {
        test('SelectOperationClass', () => {
            let nout = new outputs_1.NFTTransferOutput(1000, payload, addrs, locktime, 1);
            let goodop = new ops_1.NFTTransferOperation(nout);
            let operation = ops_1.SelectOperationClass(goodop.getOperationID());
            expect(operation).toBeInstanceOf(ops_1.NFTTransferOperation);
            expect(() => {
                ops_1.SelectOperationClass(99);
            }).toThrow("Error - SelectOperationClass: unknown opid");
        });
        test('comparator', () => {
            let op1 = new ops_1.NFTTransferOperation(new outputs_1.NFTTransferOutput(1000, payload, addrs, locktime, 1));
            let op2 = new ops_1.NFTTransferOperation(new outputs_1.NFTTransferOutput(1001, payload, addrs, locktime, 1));
            let op3 = new ops_1.NFTTransferOperation(new outputs_1.NFTTransferOutput(999, payload, addrs, locktime, 1));
            let cmp = ops_1.NFTTransferOperation.comparator();
            expect(cmp(op1, op1)).toBe(0);
            expect(cmp(op2, op2)).toBe(0);
            expect(cmp(op3, op3)).toBe(0);
            expect(cmp(op1, op2)).toBe(-1);
            expect(cmp(op1, op3)).toBe(1);
        });
        test('Functionality', () => {
            let nout = new outputs_1.NFTTransferOutput(1000, payload, addrs, locktime, 1);
            let op = new ops_1.NFTTransferOperation(nout);
            expect(op.getOperationID()).toBe(constants_1.AVMConstants.NFTXFEROPID);
            expect(op.getOutput().toString()).toBe(nout.toString());
            let opcopy = new ops_1.NFTTransferOperation();
            opcopy.fromBuffer(op.toBuffer());
            expect(opcopy.toString()).toBe(op.toString());
            op.addSignatureIdx(0, addrs[0]);
            let sigidx = op.getSigIdxs();
            expect(sigidx[0].getSource().toString("hex")).toBe(addrs[0].toString("hex"));
            opcopy.fromBuffer(op.toBuffer());
            expect(opcopy.toString()).toBe(op.toString());
        });
        test("NFTTransferOperation codecIDs", () => {
            const nftTransferOperation = new ops_1.NFTTransferOperation(new outputs_1.NFTTransferOutput(1000, payload, addrs, locktime, 1));
            expect(nftTransferOperation.getCodecID()).toBe(codecID_zero);
            expect(nftTransferOperation.getOperationID()).toBe(constants_1.AVMConstants.NFTXFEROPID);
            nftTransferOperation.setCodecID(codecID_one);
            expect(nftTransferOperation.getCodecID()).toBe(codecID_one);
            expect(nftTransferOperation.getOperationID()).toBe(constants_1.AVMConstants.NFTXFEROPID_CODECONE);
            nftTransferOperation.setCodecID(codecID_zero);
            expect(nftTransferOperation.getCodecID()).toBe(codecID_zero);
            expect(nftTransferOperation.getOperationID()).toBe(constants_1.AVMConstants.NFTXFEROPID);
        });
        test("Invalid NFTTransferOperation codecID", () => {
            const nftTransferOperation = new ops_1.NFTTransferOperation(new outputs_1.NFTTransferOutput(1000, payload, addrs, locktime, 1));
            expect(() => {
                nftTransferOperation.setCodecID(2);
            }).toThrow("Error - NFTTransferOperation.setCodecID: codecID 2, is not valid. Valid codecIDs are 0 and 1.");
        });
    });
    test('TransferableOperation', () => {
        let nout = new outputs_1.NFTTransferOutput(1000, payload, addrs, locktime, 1);
        let op = new ops_1.NFTTransferOperation(nout);
        let nfttxid = buffer_1.Buffer.from(create_hash_1.default("sha256").update(bintools.fromBNToBuffer(new bn_js_1.default(1000), 32)).digest());
        let nftoutputidx = buffer_1.Buffer.from(bintools.fromBNToBuffer(new bn_js_1.default(1000), 4));
        let nftutxo = new utxos_1.UTXO(constants_1.AVMConstants.LATESTCODEC, nfttxid, nftoutputidx, assetIDBuff, nout);
        let xferop = new ops_1.TransferableOperation(assetIDBuff, [nftutxo.getUTXOID()], op);
        let xferop2 = new ops_1.TransferableOperation(assetIDBuff, [buffer_1.Buffer.concat([nfttxid, nftoutputidx])], op);
        let uid = new ops_2.UTXOID();
        uid.fromString(nftutxo.getUTXOID());
        let xferop3 = new ops_1.TransferableOperation(assetIDBuff, [uid], op);
        expect(xferop.getAssetID().toString("hex")).toBe(assetID);
        let utxoiddeserialized = bintools.cb58Decode(xferop.getUTXOIDs()[0].toString());
        expect(bintools.bufferToB58(utxoiddeserialized)).toBe(nftutxo.getUTXOID());
        expect(xferop.getOperation().toString()).toBe(op.toString());
        let opcopy = new ops_1.TransferableOperation();
        opcopy.fromBuffer(xferop.toBuffer());
        expect(opcopy.toString()).toBe(xferop.toString());
        expect(xferop2.toBuffer().toString("hex")).toBe(xferop.toBuffer().toString('hex'));
        expect(xferop3.toBuffer().toString("hex")).toBe(xferop.toBuffer().toString('hex'));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib3BzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi90ZXN0cy9hcGlzL2F2bS9vcHMudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLDhDQUEwQztBQUMxQyw4REFBcUM7QUFDckMsa0VBQTBDO0FBQzFDLGtEQUF1QjtBQUN2QixvQ0FBK0I7QUFDL0Isa0RBQXlEO0FBQ3pELHNEQUFzRDtBQUN0RCwwQ0FBa0k7QUFDbEksOENBQWlEO0FBRWpELDBDQUEwQztBQUUxQzs7R0FFRztBQUNILE1BQU0sUUFBUSxHQUFHLGtCQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7QUFFeEMsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7SUFDeEIsTUFBTSxZQUFZLEdBQVcsQ0FBQyxDQUFDO0lBQy9CLE1BQU0sV0FBVyxHQUFXLENBQUMsQ0FBQztJQUM5QixJQUFJLE9BQU8sR0FBVSxrRUFBa0UsQ0FBQztJQUN4RixJQUFJLFdBQVcsR0FBVSxlQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNyRCxJQUFJLEtBQUssR0FBaUI7UUFDdEIsUUFBUSxDQUFDLFVBQVUsQ0FBQyxtQ0FBbUMsQ0FBQztRQUN4RCxRQUFRLENBQUMsVUFBVSxDQUFDLG1DQUFtQyxDQUFDO1FBQ3hELFFBQVEsQ0FBQyxVQUFVLENBQUMsbUNBQW1DLENBQUM7S0FDM0QsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUVULElBQUksUUFBUSxHQUFNLElBQUksZUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRWhDLElBQUksT0FBTyxHQUFVLGVBQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxpRkFBaUYsRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLE1BQU0sQ0FBRSxDQUFDO0lBRW5ILFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxHQUFHLEVBQUU7UUFDOUIs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LEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDbkYsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQ3ZGLENBQUMsQ0FBQyxDQUFDO0FBRVAsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBVVFhPIH0gZnJvbSAnc3JjL2FwaXMvYXZtL3V0eG9zJztcbmltcG9ydCBjcmVhdGVIYXNoIGZyb20gJ2NyZWF0ZS1oYXNoJztcbmltcG9ydCBCaW5Ub29scyBmcm9tICdzcmMvdXRpbHMvYmludG9vbHMnO1xuaW1wb3J0IEJOIGZyb20gJ2JuLmpzJztcbmltcG9ydCB7QnVmZmVyfSBmcm9tIFwiYnVmZmVyL1wiO1xuaW1wb3J0IHsgTkZUVHJhbnNmZXJPdXRwdXQgfSBmcm9tICdzcmMvYXBpcy9hdm0vb3V0cHV0cyc7XG5pbXBvcnQgeyBBVk1Db25zdGFudHMgfSBmcm9tICdzcmMvYXBpcy9hdm0vY29uc3RhbnRzJztcbmltcG9ydCB7IFNlbGVjdE9wZXJhdGlvbkNsYXNzLCBPcGVyYXRpb24sIFRyYW5zZmVyYWJsZU9wZXJhdGlvbiwgTkZUVHJhbnNmZXJPcGVyYXRpb24sIE5GVE1pbnRPcGVyYXRpb24gfSBmcm9tICdzcmMvYXBpcy9hdm0vb3BzJztcbmltcG9ydCB7IE91dHB1dE93bmVycyB9IGZyb20gJ3NyYy9jb21tb24vb3V0cHV0JztcbmltcG9ydCB7IFNpZ0lkeCB9IGZyb20gJ3NyYy9jb21tb24vY3JlZGVudGlhbHMnO1xuaW1wb3J0IHsgVVRYT0lEIH0gZnJvbSAnc3JjL2FwaXMvYXZtL29wcyc7XG5cbi8qKlxuICogQGlnbm9yZVxuICovXG5jb25zdCBiaW50b29scyA9IEJpblRvb2xzLmdldEluc3RhbmNlKCk7XG5cbmRlc2NyaWJlKCdPcGVyYXRpb25zJywgKCkgPT4ge1xuICAgIGNvbnN0IGNvZGVjSURfemVybzogbnVtYmVyID0gMDtcbiAgICBjb25zdCBjb2RlY0lEX29uZTogbnVtYmVyID0gMTtcbiAgICBsZXQgYXNzZXRJRDpzdHJpbmcgPSBcIjhhNWQyZDMyZTY4YmM1MDAzNmU0ZDA4NjA0NDYxN2ZlNGEwYTAyOTZiMjc0OTk5YmE1NjhlYTkyZGE0NmQ1MzNcIjtcbiAgICBsZXQgYXNzZXRJREJ1ZmY6QnVmZmVyID0gQnVmZmVyLmZyb20oYXNzZXRJRCwgXCJoZXhcIik7XG4gICAgbGV0IGFkZHJzOkFycmF5PEJ1ZmZlcj4gPSBbXG4gICAgICAgIGJpbnRvb2xzLmNiNThEZWNvZGUoXCJCNkQ0djFWdFBZTGJpVXZZWHRXNFB4OG9FOWltQzJ2R1dcIiksXG4gICAgICAgIGJpbnRvb2xzLmNiNThEZWNvZGUoXCJQNXdkUnVaZWFEdDI4ZUhNUDVTM3c5WmRvQmZvN3d1ekZcIiksXG4gICAgICAgIGJpbnRvb2xzLmNiNThEZWNvZGUoXCI2WTNreXNqRjlqbkhuWWtkUzl5R0F1b0h5YWUyZU5tZVZcIilcbiAgICBdLnNvcnQoKTtcblxuICAgIGxldCBsb2NrdGltZTpCTiA9IG5ldyBCTig1NDMyMSk7XG5cbiAgICBsZXQgcGF5bG9hZDpCdWZmZXIgPSBCdWZmZXIuYWxsb2MoMTAyNCk7XG4gICAgcGF5bG9hZC53cml0ZShcIkFsbCB5b3UgVHJla2tpZXMgYW5kIFRWIGFkZGljdHMsIERvbid0IG1lYW4gdG8gZGlzcyBkb24ndCBtZWFuIHRvIGJyaW5nIHN0YXRpYy5cIiwgMCwgMTAyNCwgXCJ1dGY4XCIgKTtcblxuICAgIGRlc2NyaWJlKCdORlRNaW50T3BlcmF0aW9uJywgKCkgPT4ge1xuICAgICAgICB0ZXN0KCdTZWxlY3RPcGVyYXRpb25DbGFzcycsICgpID0+IHtcbiAgICAgICAgICAgIGxldCBnb29kb3A6TkZUTWludE9wZXJhdGlvbiA9IG5ldyBORlRNaW50T3BlcmF0aW9uKDAsIEJ1ZmZlci5mcm9tKFwiXCIpLCBbXSk7XG4gICAgICAgICAgICBsZXQgb3BlcmF0aW9uOk9wZXJhdGlvbiA9IFNlbGVjdE9wZXJhdGlvbkNsYXNzKGdvb2RvcC5nZXRPcGVyYXRpb25JRCgpKTtcbiAgICAgICAgICAgIGV4cGVjdChvcGVyYXRpb24pLnRvQmVJbnN0YW5jZU9mKE5GVE1pbnRPcGVyYXRpb24pO1xuICAgICAgICAgICAgZXhwZWN0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBTZWxlY3RPcGVyYXRpb25DbGFzcyg5OSk7XG4gICAgICAgICAgICB9KS50b1Rocm93KFwiRXJyb3IgLSBTZWxlY3RPcGVyYXRpb25DbGFzczogdW5rbm93biBvcGlkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0ZXN0KCdjb21wYXJhdG9yJywgKCkgPT4ge1xuICAgICAgICAgICAgbGV0IG91dHB1dE93bmVyczpBcnJheTxPdXRwdXRPd25lcnM+ID0gW107XG4gICAgICAgICAgICBvdXRwdXRPd25lcnMucHVzaChuZXcgT3V0cHV0T3duZXJzKGFkZHJzLCBsb2NrdGltZSwgMSkpO1xuICAgICAgICAgICAgbGV0IG9wMTpORlRNaW50T3BlcmF0aW9uID0gbmV3IE5GVE1pbnRPcGVyYXRpb24oMSwgcGF5bG9hZCwgb3V0cHV0T3duZXJzKTtcbiAgICAgICAgICAgIGxldCBvcDI6TkZUTWludE9wZXJhdGlvbiA9IG5ldyBORlRNaW50T3BlcmF0aW9uKDIsIHBheWxvYWQsIG91dHB1dE93bmVycyk7XG4gICAgICAgICAgICBsZXQgb3AzOk5GVE1pbnRPcGVyYXRpb24gPSBuZXcgTkZUTWludE9wZXJhdGlvbigwLCBwYXlsb2FkLCBvdXRwdXRPd25lcnMpO1xuICAgICAgICAgICAgbGV0IGNtcCA9IE5GVE1pbnRPcGVyYXRpb24uY29tcGFyYXRvcigpO1xuICAgICAgICAgICAgZXhwZWN0KGNtcChvcDEsIG9wMSkpLnRvQmUoMCk7XG4gICAgICAgICAgICBleHBlY3QoY21wKG9wMiwgb3AyKSkudG9CZSgwKTtcbiAgICAgICAgICAgIGV4cGVjdChjbXAob3AzLCBvcDMpKS50b0JlKDApO1xuICAgICAgICAgICAgZXhwZWN0KGNtcChvcDEsIG9wMikpLnRvQmUoLTEpO1xuICAgICAgICAgICAgZXhwZWN0KGNtcChvcDEsIG9wMykpLnRvQmUoMSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRlc3QoJ0Z1bmN0aW9uYWxpdHknLCAoKSA9PiB7XG4gICAgICAgICAgICBsZXQgb3V0cHV0T3duZXJzOkFycmF5PE91dHB1dE93bmVycz4gPSBbXTtcbiAgICAgICAgICAgIG91dHB1dE93bmVycy5wdXNoKG5ldyBPdXRwdXRPd25lcnMoYWRkcnMsIGxvY2t0aW1lLCAxKSk7XG4gICAgICAgICAgICBsZXQgb3A6TkZUTWludE9wZXJhdGlvbiA9IG5ldyBORlRNaW50T3BlcmF0aW9uKDAsIHBheWxvYWQsIG91dHB1dE93bmVycyk7XG4gICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KG9wLmdldE9wZXJhdGlvbklEKCkpLnRvQmUoQVZNQ29uc3RhbnRzLk5GVE1JTlRPUElEKTtcbiAgICAgICAgICAgIGV4cGVjdChvcC5nZXRPdXRwdXRPd25lcnMoKS50b1N0cmluZygpKS50b0JlKG91dHB1dE93bmVycy50b1N0cmluZygpKTtcbiAgICAgICAgXG4gICAgICAgICAgICBsZXQgb3Bjb3B5Ok5GVE1pbnRPcGVyYXRpb24gPSBuZXcgTkZUTWludE9wZXJhdGlvbigpO1xuICAgICAgICAgICAgbGV0IG9wYjpCdWZmZXIgPSBvcC50b0J1ZmZlcigpO1xuICAgICAgICAgICAgb3Bjb3B5LmZyb21CdWZmZXIob3BiKTtcbiAgICAgICAgICAgIGV4cGVjdChvcGNvcHkudG9TdHJpbmcoKSkudG9CZShvcC50b1N0cmluZygpKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGVzdChcIk5GVE1pbnRPcGVyYXRpb24gY29kZWNJRHNcIiwgKCk6IHZvaWQgPT4ge1xuICAgICAgICAgIGNvbnN0IG91dHB1dE93bmVyczogT3V0cHV0T3duZXJzW10gPSBbXTtcbiAgICAgICAgICBvdXRwdXRPd25lcnMucHVzaChuZXcgT3V0cHV0T3duZXJzKGFkZHJzLCBsb2NrdGltZSwgMSkpO1xuICAgICAgICAgIGNvbnN0IG5mdE1pbnRPcGVyYXRpb246IE5GVE1pbnRPcGVyYXRpb24gPSBuZXcgTkZUTWludE9wZXJhdGlvbigwLCBwYXlsb2FkLCBvdXRwdXRPd25lcnMpO1xuICAgICAgICAgIGV4cGVjdChuZnRNaW50T3BlcmF0aW9uLmdldENvZGVjSUQoKSkudG9CZShjb2RlY0lEX3plcm8pO1xuICAgICAgICAgIGV4cGVjdChuZnRNaW50T3BlcmF0aW9uLmdldE9wZXJhdGlvbklEKCkpLnRvQmUoQVZNQ29uc3RhbnRzLk5GVE1JTlRPUElEKTtcbiAgICAgICAgICBuZnRNaW50T3BlcmF0aW9uLnNldENvZGVjSUQoY29kZWNJRF9vbmUpXG4gICAgICAgICAgZXhwZWN0KG5mdE1pbnRPcGVyYXRpb24uZ2V0Q29kZWNJRCgpKS50b0JlKGNvZGVjSURfb25lKTtcbiAgICAgICAgICBleHBlY3QobmZ0TWludE9wZXJhdGlvbi5nZXRPcGVyYXRpb25JRCgpKS50b0JlKEFWTUNvbnN0YW50cy5ORlRNSU5UT1BJRF9DT0RFQ09ORSk7XG4gICAgICAgICAgbmZ0TWludE9wZXJhdGlvbi5zZXRDb2RlY0lEKGNvZGVjSURfemVybylcbiAgICAgICAgICBleHBlY3QobmZ0TWludE9wZXJhdGlvbi5nZXRDb2RlY0lEKCkpLnRvQmUoY29kZWNJRF96ZXJvKTtcbiAgICAgICAgICBleHBlY3QobmZ0TWludE9wZXJhdGlvbi5nZXRPcGVyYXRpb25JRCgpKS50b0JlKEFWTUNvbnN0YW50cy5ORlRNSU5UT1BJRCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRlc3QoXCJJbnZhbGlkIE5GVE1pbnRPcGVyYXRpb24gY29kZWNJRFwiLCAoKTogdm9pZCA9PiB7XG4gICAgICAgICAgY29uc3Qgb3V0cHV0T3duZXJzOiBPdXRwdXRPd25lcnNbXSA9IFtdO1xuICAgICAgICAgIG91dHB1dE93bmVycy5wdXNoKG5ldyBPdXRwdXRPd25lcnMoYWRkcnMsIGxvY2t0aW1lLCAxKSk7XG4gICAgICAgICAgY29uc3QgbmZ0TWludE9wZXJhdGlvbjogTkZUTWludE9wZXJhdGlvbiA9IG5ldyBORlRNaW50T3BlcmF0aW9uKDAsIHBheWxvYWQsIG91dHB1dE93bmVycyk7XG4gICAgICAgICAgZXhwZWN0KCgpID0+IHtcbiAgICAgICAgICAgIG5mdE1pbnRPcGVyYXRpb24uc2V0Q29kZWNJRCgyKVxuICAgICAgICAgIH0pLnRvVGhyb3coXCJFcnJvciAtIE5GVE1pbnRPcGVyYXRpb24uc2V0Q29kZWNJRDogY29kZWNJRCAyLCBpcyBub3QgdmFsaWQuIFZhbGlkIGNvZGVjSURzIGFyZSAwIGFuZCAxLlwiKTtcbiAgICAgICAgfSk7XG4gICAgfSlcblxuICAgIGRlc2NyaWJlKCdORlRUcmFuc2Zlck9wZXJhdGlvbicsICgpID0+IHtcbiAgICAgICAgdGVzdCgnU2VsZWN0T3BlcmF0aW9uQ2xhc3MnLCAoKSA9PiB7XG4gICAgICAgICAgICBsZXQgbm91dDpORlRUcmFuc2Zlck91dHB1dCA9IG5ldyBORlRUcmFuc2Zlck91dHB1dCgxMDAwLCBwYXlsb2FkLCBhZGRycywgbG9ja3RpbWUsIDEpO1xuICAgICAgICAgICAgbGV0IGdvb2RvcDpORlRUcmFuc2Zlck9wZXJhdGlvbiA9IG5ldyBORlRUcmFuc2Zlck9wZXJhdGlvbihub3V0KTtcbiAgICAgICAgICAgIGxldCBvcGVyYXRpb246T3BlcmF0aW9uID0gU2VsZWN0T3BlcmF0aW9uQ2xhc3MoZ29vZG9wLmdldE9wZXJhdGlvbklEKCkpO1xuICAgICAgICAgICAgZXhwZWN0KG9wZXJhdGlvbikudG9CZUluc3RhbmNlT2YoTkZUVHJhbnNmZXJPcGVyYXRpb24pO1xuICAgICAgICAgICAgZXhwZWN0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBTZWxlY3RPcGVyYXRpb25DbGFzcyg5OSk7XG4gICAgICAgICAgICB9KS50b1Rocm93KFwiRXJyb3IgLSBTZWxlY3RPcGVyYXRpb25DbGFzczogdW5rbm93biBvcGlkXCIpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0ZXN0KCdjb21wYXJhdG9yJywgKCkgPT4ge1xuICAgICAgICAgICAgbGV0IG9wMTpORlRUcmFuc2Zlck9wZXJhdGlvbiA9IG5ldyBORlRUcmFuc2Zlck9wZXJhdGlvbihuZXcgTkZUVHJhbnNmZXJPdXRwdXQoMTAwMCwgcGF5bG9hZCwgYWRkcnMsIGxvY2t0aW1lLCAxKSk7XG4gICAgICAgICAgICBsZXQgb3AyOk5GVFRyYW5zZmVyT3BlcmF0aW9uID0gbmV3IE5GVFRyYW5zZmVyT3BlcmF0aW9uKG5ldyBORlRUcmFuc2Zlck91dHB1dCgxMDAxLCBwYXlsb2FkLCBhZGRycywgbG9ja3RpbWUsIDEpKTtcbiAgICAgICAgICAgIGxldCBvcDM6TkZUVHJhbnNmZXJPcGVyYXRpb24gPSBuZXcgTkZUVHJhbnNmZXJPcGVyYXRpb24obmV3IE5GVFRyYW5zZmVyT3V0cHV0KDk5OSwgcGF5bG9hZCwgYWRkcnMsIGxvY2t0aW1lLCAxKSk7XG4gICAgICAgICAgICBsZXQgY21wID0gTkZUVHJhbnNmZXJPcGVyYXRpb24uY29tcGFyYXRvcigpO1xuICAgICAgICAgICAgZXhwZWN0KGNtcChvcDEsIG9wMSkpLnRvQmUoMCk7XG4gICAgICAgICAgICBleHBlY3QoY21wKG9wMiwgb3AyKSkudG9CZSgwKTtcbiAgICAgICAgICAgIGV4cGVjdChjbXAob3AzLCBvcDMpKS50b0JlKDApO1xuICAgICAgICAgICAgZXhwZWN0KGNtcChvcDEsIG9wMikpLnRvQmUoLTEpO1xuICAgICAgICAgICAgZXhwZWN0KGNtcChvcDEsIG9wMykpLnRvQmUoMSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRlc3QoJ0Z1bmN0aW9uYWxpdHknLCAoKSA9PiB7XG4gICAgICAgICAgICBsZXQgbm91dDpORlRUcmFuc2Zlck91dHB1dCA9IG5ldyBORlRUcmFuc2Zlck91dHB1dCgxMDAwLCBwYXlsb2FkLCBhZGRycywgbG9ja3RpbWUsIDEpO1xuICAgICAgICAgICAgbGV0IG9wOk5GVFRyYW5zZmVyT3BlcmF0aW9uID0gbmV3IE5GVFRyYW5zZmVyT3BlcmF0aW9uKG5vdXQpO1xuICAgICAgICBcbiAgICAgICAgICAgIGV4cGVjdChvcC5nZXRPcGVyYXRpb25JRCgpKS50b0JlKEFWTUNvbnN0YW50cy5ORlRYRkVST1BJRCk7XG4gICAgICAgICAgICBleHBlY3Qob3AuZ2V0T3V0cHV0KCkudG9TdHJpbmcoKSkudG9CZShub3V0LnRvU3RyaW5nKCkpO1xuICAgICAgICBcbiAgICAgICAgICAgIGxldCBvcGNvcHk6TkZUVHJhbnNmZXJPcGVyYXRpb24gPSBuZXcgTkZUVHJhbnNmZXJPcGVyYXRpb24oKTtcbiAgICAgICAgICAgIG9wY29weS5mcm9tQnVmZmVyKG9wLnRvQnVmZmVyKCkpO1xuICAgICAgICAgICAgZXhwZWN0KG9wY29weS50b1N0cmluZygpKS50b0JlKG9wLnRvU3RyaW5nKCkpO1xuICAgICAgICBcbiAgICAgICAgICAgIG9wLmFkZFNpZ25hdHVyZUlkeCgwLCBhZGRyc1swXSk7XG4gICAgICAgICAgICBsZXQgc2lnaWR4OkFycmF5PFNpZ0lkeD4gPSBvcC5nZXRTaWdJZHhzKCk7XG4gICAgICAgICAgICBleHBlY3Qoc2lnaWR4WzBdLmdldFNvdXJjZSgpLnRvU3RyaW5nKFwiaGV4XCIpKS50b0JlKGFkZHJzWzBdLnRvU3RyaW5nKFwiaGV4XCIpKTtcbiAgICAgICAgICAgIG9wY29weS5mcm9tQnVmZmVyKG9wLnRvQnVmZmVyKCkpO1xuICAgICAgICAgICAgZXhwZWN0KG9wY29weS50b1N0cmluZygpKS50b0JlKG9wLnRvU3RyaW5nKCkpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0ZXN0KFwiTkZUVHJhbnNmZXJPcGVyYXRpb24gY29kZWNJRHNcIiwgKCk6IHZvaWQgPT4ge1xuICAgICAgICAgIGNvbnN0IG5mdFRyYW5zZmVyT3BlcmF0aW9uOiBORlRUcmFuc2Zlck9wZXJhdGlvbiA9IG5ldyBORlRUcmFuc2Zlck9wZXJhdGlvbihuZXcgTkZUVHJhbnNmZXJPdXRwdXQoMTAwMCwgcGF5bG9hZCwgYWRkcnMsIGxvY2t0aW1lLCAxKSk7XG4gICAgICAgICAgZXhwZWN0KG5mdFRyYW5zZmVyT3BlcmF0aW9uLmdldENvZGVjSUQoKSkudG9CZShjb2RlY0lEX3plcm8pO1xuICAgICAgICAgIGV4cGVjdChuZnRUcmFuc2Zlck9wZXJhdGlvbi5nZXRPcGVyYXRpb25JRCgpKS50b0JlKEFWTUNvbnN0YW50cy5ORlRYRkVST1BJRCk7XG4gICAgICAgICAgbmZ0VHJhbnNmZXJPcGVyYXRpb24uc2V0Q29kZWNJRChjb2RlY0lEX29uZSlcbiAgICAgICAgICBleHBlY3QobmZ0VHJhbnNmZXJPcGVyYXRpb24uZ2V0Q29kZWNJRCgpKS50b0JlKGNvZGVjSURfb25lKTtcbiAgICAgICAgICBleHBlY3QobmZ0VHJhbnNmZXJPcGVyYXRpb24uZ2V0T3BlcmF0aW9uSUQoKSkudG9CZShBVk1Db25zdGFudHMuTkZUWEZFUk9QSURfQ09ERUNPTkUpO1xuICAgICAgICAgIG5mdFRyYW5zZmVyT3BlcmF0aW9uLnNldENvZGVjSUQoY29kZWNJRF96ZXJvKVxuICAgICAgICAgIGV4cGVjdChuZnRUcmFuc2Zlck9wZXJhdGlvbi5nZXRDb2RlY0lEKCkpLnRvQmUoY29kZWNJRF96ZXJvKTtcbiAgICAgICAgICBleHBlY3QobmZ0VHJhbnNmZXJPcGVyYXRpb24uZ2V0T3BlcmF0aW9uSUQoKSkudG9CZShBVk1Db25zdGFudHMuTkZUWEZFUk9QSUQpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0ZXN0KFwiSW52YWxpZCBORlRUcmFuc2Zlck9wZXJhdGlvbiBjb2RlY0lEXCIsICgpOiB2b2lkID0+IHtcbiAgICAgICAgICBjb25zdCBuZnRUcmFuc2Zlck9wZXJhdGlvbjogTkZUVHJhbnNmZXJPcGVyYXRpb24gPSBuZXcgTkZUVHJhbnNmZXJPcGVyYXRpb24obmV3IE5GVFRyYW5zZmVyT3V0cHV0KDEwMDAsIHBheWxvYWQsIGFkZHJzLCBsb2NrdGltZSwgMSkpO1xuICAgICAgICAgIGV4cGVjdCgoKSA9PiB7XG4gICAgICAgICAgICBuZnRUcmFuc2Zlck9wZXJhdGlvbi5zZXRDb2RlY0lEKDIpXG4gICAgICAgICAgfSkudG9UaHJvdyhcIkVycm9yIC0gTkZUVHJhbnNmZXJPcGVyYXRpb24uc2V0Q29kZWNJRDogY29kZWNJRCAyLCBpcyBub3QgdmFsaWQuIFZhbGlkIGNvZGVjSURzIGFyZSAwIGFuZCAxLlwiKTtcbiAgICAgICAgfSk7XG4gICAgfSlcblxuXG4gICAgdGVzdCgnVHJhbnNmZXJhYmxlT3BlcmF0aW9uJywgKCkgPT4ge1xuICAgICAgICBsZXQgbm91dDpORlRUcmFuc2Zlck91dHB1dCA9IG5ldyBORlRUcmFuc2Zlck91dHB1dCgxMDAwLCBwYXlsb2FkLCBhZGRycywgbG9ja3RpbWUsIDEpO1xuICAgICAgICBsZXQgb3A6TkZUVHJhbnNmZXJPcGVyYXRpb24gPSBuZXcgTkZUVHJhbnNmZXJPcGVyYXRpb24obm91dCk7XG4gICAgICAgIGxldCBuZnR0eGlkOkJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGNyZWF0ZUhhc2goXCJzaGEyNTZcIikudXBkYXRlKGJpbnRvb2xzLmZyb21CTlRvQnVmZmVyKG5ldyBCTigxMDAwKSwgMzIpKS5kaWdlc3QoKSk7XG4gICAgICAgIGxldCBuZnRvdXRwdXRpZHg6QnVmZmVyID0gQnVmZmVyLmZyb20oYmludG9vbHMuZnJvbUJOVG9CdWZmZXIobmV3IEJOKDEwMDApLCA0KSk7XG4gICAgICAgIGxldCBuZnR1dHhvOlVUWE8gPSBuZXcgVVRYTyhBVk1Db25zdGFudHMuTEFURVNUQ09ERUMsIG5mdHR4aWQsIG5mdG91dHB1dGlkeCwgYXNzZXRJREJ1ZmYsIG5vdXQpO1xuICAgICAgICBsZXQgeGZlcm9wOlRyYW5zZmVyYWJsZU9wZXJhdGlvbiA9IG5ldyBUcmFuc2ZlcmFibGVPcGVyYXRpb24oYXNzZXRJREJ1ZmYsIFtuZnR1dHhvLmdldFVUWE9JRCgpXSwgb3ApO1xuXG4gICAgICAgIGxldCB4ZmVyb3AyOlRyYW5zZmVyYWJsZU9wZXJhdGlvbiA9IG5ldyBUcmFuc2ZlcmFibGVPcGVyYXRpb24oYXNzZXRJREJ1ZmYsIFtCdWZmZXIuY29uY2F0KFtuZnR0eGlkLCBuZnRvdXRwdXRpZHhdKV0sIG9wKTsgXG4gICAgICAgIGxldCB1aWQ6VVRYT0lEID0gbmV3IFVUWE9JRCgpO1xuICAgICAgICB1aWQuZnJvbVN0cmluZyhuZnR1dHhvLmdldFVUWE9JRCgpKTtcbiAgICAgICAgbGV0IHhmZXJvcDM6VHJhbnNmZXJhYmxlT3BlcmF0aW9uID0gbmV3IFRyYW5zZmVyYWJsZU9wZXJhdGlvbihhc3NldElEQnVmZiwgW3VpZF0sIG9wKTtcblxuICAgICAgICBleHBlY3QoeGZlcm9wLmdldEFzc2V0SUQoKS50b1N0cmluZyhcImhleFwiKSkudG9CZShhc3NldElEKTtcbiAgICAgICAgbGV0IHV0eG9pZGRlc2VyaWFsaXplZDpCdWZmZXIgPSBiaW50b29scy5jYjU4RGVjb2RlKHhmZXJvcC5nZXRVVFhPSURzKClbMF0udG9TdHJpbmcoKSk7XG4gICAgICAgIGV4cGVjdChiaW50b29scy5idWZmZXJUb0I1OCh1dHhvaWRkZXNlcmlhbGl6ZWQpKS50b0JlKG5mdHV0eG8uZ2V0VVRYT0lEKCkpO1xuICAgICAgICBleHBlY3QoeGZlcm9wLmdldE9wZXJhdGlvbigpLnRvU3RyaW5nKCkpLnRvQmUob3AudG9TdHJpbmcoKSk7XG5cbiAgICAgICAgbGV0IG9wY29weTpUcmFuc2ZlcmFibGVPcGVyYXRpb24gPSBuZXcgVHJhbnNmZXJhYmxlT3BlcmF0aW9uKCk7XG4gICAgICAgIG9wY29weS5mcm9tQnVmZmVyKHhmZXJvcC50b0J1ZmZlcigpKTtcbiAgICAgICAgZXhwZWN0KG9wY29weS50b1N0cmluZygpKS50b0JlKHhmZXJvcC50b1N0cmluZygpKTtcblxuICAgICAgICBleHBlY3QoeGZlcm9wMi50b0J1ZmZlcigpLnRvU3RyaW5nKFwiaGV4XCIpKS50b0JlKHhmZXJvcC50b0J1ZmZlcigpLnRvU3RyaW5nKCdoZXgnKSk7XG4gICAgICAgIGV4cGVjdCh4ZmVyb3AzLnRvQnVmZmVyKCkudG9TdHJpbmcoXCJoZXhcIikpLnRvQmUoeGZlcm9wLnRvQnVmZmVyKCkudG9TdHJpbmcoJ2hleCcpKTtcbiAgICB9KTtcblxufSk7Il19